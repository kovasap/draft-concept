{"version":3,"sources":["app/interface/sente.cljs"],"mappings":"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","names":["app.interface.sente/?csrf-token","temp__5804__auto__","el","js/document","cljs.core.prn","app.config/api-host","map__74407","cljs.core/--destructure-map","cljs.core.get","chsk","ch-recv","send-fn","state","taoensso.sente.make_channel_socket_client_BANG_","app.config/api-port","app.interface.sente/chsk","app.interface.sente/ch-chsk","app.interface.sente/chsk-send!","app.interface.sente/chsk-state","app.interface.sente/remove-fns","data","clojure.walk/prewalk","node","cljs.core/map?","cljs.core.into","iter__5520__auto__","s__74409","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__5518__auto__","size__5519__auto__","cljs.core/count","b__74411","cljs.core/chunk-buffer","i__74410","vec__74412","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__74408","cljs.core/chunk-rest","vec__74415","cljs.core/first","cljs.core/cons","cljs.core/rest","k","v","cljs.core/fn?","app.interface.sente/send-state-to-server!","db","G__74418","G__74419","G__74420","cb-reply","re_frame.core.reg_event_db","p__74421","vec__74422","_","db-from-server","app.interface.sente/login","user-id","req","taoensso.timbre._log_BANG_","taoensso.timbre/*config*","cljs.core/Delay","G__74425","G__74426","G__74427","taoensso.sente/ajax-lite","ajax-resp","login-successful?","taoensso.sente/chsk-reconnect!","js/app","js/app.interface","js/app.interface.sente","js/app.interface.sente.-event-msg-handler","method-table__5639__auto__","cljs.core.atom","prefer-table__5640__auto__","method-cache__5641__auto__","cached-hierarchy__5642__auto__","hierarchy__5643__auto__","fexpr__74430","cljs.core/MultiFn","cljs.core.symbol","app.interface.sente/-event-msg-handler","p__74431","map__74432","app.interface.sente/event-msg-handler","ev-msg","id","?data","event","p__74433","map__74434","p__74435","map__74436","vec__74437","old-state-map","new-state-map","e","taoensso.truss.impl/-dummy-error","e74442","js/Error","taoensso.truss.impl/-invar-violation!","cljs.core/vector?","p__74444","map__74445","vec__74446","vec__74449","ev-name","cljs.core._EQ_","re-frame.core/dispatch","p__74455","map__74456","vec__74458","?uid","?csrf-token","?handshake-data","js/app.interface.sente.router_","app.interface.sente/router_","app.interface.sente/stop-router!","cljs.core/deref","stop-f","app.interface.sente/start-router!","cljs.core/reset!","taoensso.sente/start-client-chsk-router!","app.interface.sente/start!","js/app.interface.sente._start-once","app.interface.sente/_start-once","cljs.core/chunk-first"],"sourcesContent":["(ns app.interface.sente\n  (:require [cljs.core.async :as async :refer (<! >! put! chan)]\n            [app.config :as config]\n            [clojure.walk :refer [prewalk]]\n            [re-frame.core :as rf]\n            [taoensso.timbre :as log]\n            [taoensso.encore :as encore :refer-macros (have have?)]\n            [taoensso.sente :as sente :refer (cb-success?)]))\n\n(def ?csrf-token\n  (when-let [el (.getElementById js/document \"sente-csrf-token\")]\n    (.getAttribute el \"data-csrf-token\")))\n\n(prn \"TOKEN\" ?csrf-token)\n(prn \"HOST\" config/api-host)\n\n\n(let [{:keys [chsk ch-recv send-fn state]}\n      (sente/make-channel-socket-client!\n       \"/chsk\"\n       ?csrf-token\n       {:type :auto\n        :packer :edn\n        :host config/api-host\n        :port config/api-port})] ; e/o #{:auto :ajax :ws}\n  (def chsk       chsk)\n  (def ch-chsk    ch-recv) ; ChannelSocket's receive channel\n  (def chsk-send! send-fn) ; ChannelSocket's send API fn\n  (def chsk-state state))   ; Watchable, read-only atom\n\n\n\n; Syncing Game State\n\n(defn remove-fns\n  \"Useful for removing functions from the db before sending to the server.\n  \n  Currently only removes functions if they are values in a map, not if they are\n  elements of a vector/list.\"\n  [data]\n  (prewalk (fn [node] (if (map? node)\n                        (into {} (for [[k v] node\n                                       :when (not (fn? v))]\n                                   [k v]))\n                        node))\n           data))\n\n(defn send-state-to-server!\n  [db]\n  (chsk-send! [:app/sync-state {:db (remove-fns db)}] 5000\n              (fn [cb-reply] (prn \"sent state to server\"))))\n\n\n\n(rf/reg-event-db\n  :game/update-state\n  (fn [_ [_ db-from-server]]\n     db-from-server))\n\n\n\n(defn login \n \"Use any login procedure you'd like. Here we'll trigger an Ajax\nPOST request that resets our server-side session. Then we ask\nour channel socket to reconnect, thereby picking up the new\nsession.\"\n [user-id]\n (let [req    {:method :post\n               :headers {:X-CSRF-Token ?csrf-token}\n               :params  {:user-id (str user-id)}}]\n   (log/infof \"Trying login with %s\" req)\n   (sente/ajax-lite \"/login\" req\n     (fn [ajax-resp]\n       (log/infof \"Ajax login response: %s\" ajax-resp)\n       (let [login-successful? true] ; Your logic here\n          \n         (if-not login-successful?\n           (log/infof \"Login failed for %s\" user-id)\n           (do\n             (log/infof \"Login successful for %s\" user-id)\n             (sente/chsk-reconnect! chsk))))))))\n\n;;;; Sente event handlers\n\n(defmulti -event-msg-handler\n  \"Multimethod to handle Sente `event-msg`s\"\n  :id) ; Dispatch on event-id\n  \n\n(defn event-msg-handler\n  \"Wraps `-event-msg-handler` with logging, error catching, etc.\"\n  [{:as ev-msg :keys [id ?data event]}]\n  (-event-msg-handler ev-msg))\n\n(defmethod -event-msg-handler\n  :default ; Default/fallback case (no other matching handler)\n  [{:as ev-msg :keys [event]}]\n  (log/infof \"Unhandled event: %s\" event))\n\n(defmethod -event-msg-handler :chsk/state\n  [{:as ev-msg :keys [?data]}]\n  (let [[old-state-map new-state-map] (have vector? ?data)]\n    (if (:first-open? new-state-map)\n      (log/infof \"Channel socket successfully established!: %s\" new-state-map)\n      (log/infof \"Channel socket state change: %s\"              new-state-map))))\n\n(defmethod -event-msg-handler :chsk/recv\n  [{:as ev-msg :keys [event]}]\n  (let [[_ [ev-name data]] event]\n    (if (= ev-name :game/broadcast-state)\n      (do\n        (prn \"Got game state from server!\")\n        (rf/dispatch [:game/update-state (:db data)]))\n      (log/infof \"Push event from server: %s\" ev-msg))))\n\n(defmethod -event-msg-handler :chsk/handshake\n  [{:as ev-msg :keys [?data]}]\n  (let [[?uid ?csrf-token ?handshake-data] ?data]\n    (log/infof \"Handshake: %s\" ?data ?uid)))\n\n;; TODO Add your (defmethod -event-msg-handler <event-id> [ev-msg] <body>)s here...\n\n;;;; Sente event router (our `event-msg-handler` loop)\n\n(defonce router_ (atom nil))\n(defn  stop-router! [] (when-let [stop-f @router_] (stop-f)))\n(defn start-router! []\n  (stop-router!)\n  (reset! router_\n    (sente/start-client-chsk-router!\n      ch-chsk event-msg-handler)))\n\n\n(defn start! [] (start-router!))\n\n(defonce _start-once (start!))\n"]}